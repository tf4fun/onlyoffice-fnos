x-fnpack:
  manifest:
    appname: "docker-onlyoffice"
    desc: "OnlyOffice 文档编辑器 - 在浏览器中编辑 Office 文档"
    display_name: "OnlyOffice-FNOS"
    version: "1.0.0"
    maintainer: "tf4fun"
    maintainer_url: "https://github.com/tf4fun"
    distributor: "tf4fun"
    distributor_url: "https://github.com/tf4fun"

  cmd/install_init: |
    #!/bin/bash
    # install_init: 在 app.tgz 解压前修改 compose.yaml

    COMPOSE_FILE="${TRIM_PKGINST_TEMP_DIR}/docker/docker-compose.yaml"

    # 调试：查看 compose 文件是否存在
    if [ ! -f "$COMPOSE_FILE" ]; then
      echo "错误: compose 文件不存在: $COMPOSE_FILE" > "${TRIM_TEMP_LOGFILE}"
      exit 1
    fi

    export COMPOSE_FILE
    python3 >> "${TRIM_TEMP_LOGFILE}" 2>&1 << 'EOF'
    import yaml
    import os
    import glob

    compose_file = os.environ.get('COMPOSE_FILE', '')

    with open(compose_file, 'r') as f:
        data = yaml.safe_load(f)

    volumes = [f"{v}:{v}" for v in sorted(glob.glob('/vol*')) if os.path.isdir(v)]
    data['services']['onlyoffice-connector']['volumes'] = volumes

    with open(compose_file, 'w') as f:
        yaml.dump(data, f, default_flow_style=False, allow_unicode=True)

    print(f"volumes 已更新: {volumes}")
    EOF

  wizard/install: |
    [
      {
        "stepTitle": "OnlyOffice 配置",
        "items": [
          {"type": "tips", "helpText": "配置 JWT 密钥用于安全通信。"},
          {
            "type": "text",
            "helpText": "JWT 密钥，用于 Document Server 安全通信",
            "field": "wizard_jwt_secret",
            "label": "JWT 密钥",
            "initValue": "your-secret-key-change-me",
            "rules": [
              {"required": true, "message": "此字段不能为空"},
              {"min": 16, "max": 64, "message": "长度应在16-64个字符之间"}
            ]
          }
        ]
      }
    ]

  app/ui/config: |
    {
      ".url": {
        "docker-onlyoffice.editor": {
          "title": "使用 OnlyOffice 打开",
          "icon": "images/icon-{0}.png",
          "type": "iframe",
          "protocol": "http",
          "port": "9080",
          "url": "/editor",
          "allUsers": true,
          "fileTypes": ["docx", "xlsx", "pptx", "doc", "xls", "ppt", "odt", "ods", "odp", "pdf", "txt", "rtf", "csv", "djvu", "oxps", "epub", "fb2"],
          "noDisplay": true
        }
      }
    }

  config/resource: |
    {
      "docker-project": {
        "projects": [{"name": "onlyoffice", "path": "docker"}]
      },
      "data-share": {
        "shares": [
          {"name": "onlyoffice", "permission": {"rw": ["docker-onlyoffice"]}},
          {"name": "onlyoffice/data", "permission": {"rw": ["docker-onlyoffice"]}},
          {"name": "onlyoffice/log", "permission": {"rw": ["docker-onlyoffice"]}},
          {"name": "onlyoffice/lib", "permission": {"rw": ["docker-onlyoffice"]}},
          {"name": "onlyoffice/plugins", "permission": {"rw": ["docker-onlyoffice"]}},
          {"name": "onlyoffice/fonts", "permission": {"rw": ["docker-onlyoffice"]}}
        ]
      }
    }

  config/privilege: |
    {"defaults": {"run-as": "root"}}

networks:
  onlyoffice-net:
    name: onlyoffice-net
    driver: bridge

services:
  onlyoffice-connector:
    image: xingheliufang/onlyoffice-fnos:main
    container_name: onlyoffice-connector
    networks:
      - onlyoffice-net
    restart: unless-stopped
    ports:
      - 9080:10099
    command: ["--mode=server"]
    environment:
      - DOCUMENT_SERVER_URL=http://onlyoffice-doc-svr:80
      - DOCUMENT_SERVER_SECRET=${wizard_jwt_secret}
      - BASE_URL=http://onlyoffice-connector:10099
      - DOC_SERVER_PATH=/doc-svr
    depends_on:
      - onlyoffice-documentserver

  onlyoffice-documentserver:
    image: onlyoffice/documentserver:latest
    container_name: onlyoffice-doc-svr
    networks:
      - onlyoffice-net
    restart: unless-stopped
    stop_grace_period: 60s
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=${wizard_jwt_secret}
      - JWT_HEADER=Authorization
      - JWT_IN_BODY=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/info/info.json"]
      interval: 30s
      retries: 5
      start_period: 60s
      timeout: 10s
    volumes:
      - /var/apps/docker-onlyoffice/shares/onlyoffice/data:/var/www/onlyoffice/Data
      - /var/apps/docker-onlyoffice/shares/onlyoffice/log:/var/log/onlyoffice
      - /var/apps/docker-onlyoffice/shares/onlyoffice/lib:/var/lib/onlyoffice
      - /var/apps/docker-onlyoffice/shares/onlyoffice/plugins:/var/www/onlyoffice/documentserver/sdkjs-plugins
      - /var/apps/docker-onlyoffice/shares/onlyoffice/fonts:/usr/share/fonts/truetype/custom
