networks:
  onlyoffice-net:
    name: onlyoffice-net
    driver: bridge

configs:
  traefik_yaml:
    content: |
      http:
        routers:
          onlyoffice-doc-svr:
            rule: "PathPrefix(`/doc-svr`)"
            service: onlyoffice-doc-svr
            entryPoints:
              - web
            middlewares:
              - onlyoffice-headers
            priority: 10
          onlyoffice-connector:
            rule: "PathPrefix(`/`)"
            service: onlyoffice-connector
            entryPoints:
              - web
            priority: 1
        services:
          onlyoffice-doc-svr:
            loadBalancer:
              servers:
                - url: "http://onlyoffice-doc-svr:80"
          onlyoffice-connector:
            loadBalancer:
              servers:
                - url: "http://onlyoffice-connector:10099"
        middlewares:
          onlyoffice-headers:
            headers:
              customRequestHeaders:
                X-Forwarded-Prefix: "/doc-svr"
              accessControlAllowOriginList:
                - "*"

services:
  onlyoffice-traefik:
    image: traefik:latest
    container_name: onlyoffice-traefik
    networks:
      - onlyoffice-net
    restart: unless-stopped
    configs:
      - source: traefik_yaml
        target: /config/traefik.yaml
    command:
      - --api=true
      - --accesslog=true
      - --log.level=DEBUG
      - --providers.file.filename=/config/traefik.yaml
      - --providers.file.watch=true
      - --entrypoints.web.address=:80
    ports:
      - '9080:80'
    labels:
      watchcow.enable: "true"
      watchcow.editor.service_port: "9080"
      watchcow.editor.protocol: "http"
      watchcow.editor.path: "/editor"
      watchcow.editor.ui_type: "iframe"
      watchcow.editor.all_users: "true"
      watchcow.editor.title: "使用 OnlyOffice 打开"
      watchcow.editor.file_types: "docx,xlsx,pptx,doc,xls,ppt,odt,ods,odp,pdf,txt,rtf,csv,djvu,oxps,epub,fb2"
      watchcow.editor.icon: "file://onlyoffice.png"
      watchcow.editor.no_display: "true"

  onlyoffice-connector:
    image: xingheliufang/onlyoffice-fnos:main
    container_name: onlyoffice-connector
    networks:
      - onlyoffice-net
    restart: unless-stopped
    environment:
      - DOCUMENT_SERVER_URL=http://onlyoffice-doc-svr:80  # 内网直连，用于后端 API 调用
      - DOCUMENT_SERVER_SECRET=ca64a350c233f2be2c44a1051d068a56
      - BASE_URL=http://onlyoffice-connector:10099
      - DOC_SERVER_PATH=/doc-svr  # 前端相对路径
    # ports:
    #   - '10099:10099'
    volumes:
      - /vol00:/vol00
      - /vol1:/vol1
      - /vol2:/vol2

  onlyoffice-documentserver:
    image: onlyoffice/documentserver:latest
    container_name: onlyoffice-doc-svr
    networks:
      - onlyoffice-net
    restart: unless-stopped
    stop_grace_period: 60s
    # ports:
    #   - '10098:80'  # 暴露端口供外部访问
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=ca64a350c233f2be2c44a1051d068a56
      - JWT_HEADER=Authorization
      - JWT_IN_BODY=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/info/info.json"]
      interval: 30s
      retries: 5
      start_period: 60s
      timeout: 10s
    volumes:
      - ./volumes/data:/var/www/onlyoffice/Data
      - ./volumes/log:/var/log/onlyoffice
      - ./volumes/lib:/var/lib/onlyoffice
      - ./volumes/plugins:/var/www/onlyoffice/documentserver/sdkjs-plugins
      - ./volumes/fonts:/usr/share/fonts/truetype/custom